!function(t){"use strict";const e={autoInit:!0,size:32,fallbackColor:"#2563eb",textColor:"#ffffff",fontFamily:"Arial, sans-serif",enableShadow:!0,enableLogging:!1,retryAttempts:3,timeout:2e3,enableCaching:!0,cacheExpiration:7,respectExisting:!0,forceRegenerate:!1,checkImplicitFavicon:!1};class FaviconGenerator{constructor(t={}){this.config={...e,...t},this.canvas=null,this.ctx=null,this.initialized=!1,this.retryCount=0,this.cacheKey="auto-favicon-cache",this.pageSignature=null,this.log("FaviconGenerator initialized with config:",this.config),this.config.autoInit&&this.init()}init(){return this.initialized?(this.log("FaviconGenerator already initialized"),Promise.resolve()):new Promise(((t,e)=>{try{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{this.checkAndGenerate().then(t).catch(e)})):this.checkAndGenerate().then(t).catch(e)}catch(t){this.logError("Initialization error:",t),e(t)}}))}async checkAndGenerate(){try{if(this.config.respectExisting&&!this.config.forceRegenerate){const t=await this.detectExistingFavicon();if(t)return this.log("Existing favicon detected, skipping generation:",t),this.initialized=!0,null}if(this.pageSignature=this.generatePageSignature(),this.log("Page signature generated:",this.pageSignature),this.config.enableCaching&&!this.config.forceRegenerate){const t=this.getCachedFavicon();if(t)return this.log("Using cached favicon"),this.applyFavicon(t),this.initialized=!0,t}const t=await this.generate();return this.config.enableCaching&&t&&this.cacheFavicon(t),t}catch(t){throw this.logError("Error in checkAndGenerate:",t),t}}async detectExistingFavicon(){try{const t=['link[rel="icon"]','link[rel="shortcut icon"]','link[rel="apple-touch-icon"]','link[rel="apple-touch-icon-precomposed"]','link[type="image/x-icon"]','link[type="image/vnd.microsoft.icon"]','link[type="image/png"]','link[type="image/gif"]','link[type="image/jpeg"]'];for(const e of t){const t=document.querySelectorAll(e);for(const i of t){if(i.hasAttribute("data-auto-generated"))continue;const t=i.getAttribute("href");if(t&&""!==t.trim()&&"#"!==t)return this.log(`Found existing favicon: ${e} with href: ${t}`),{element:i,href:t,type:i.getAttribute("type")||"unknown"}}}if(this.config.checkImplicitFavicon){if(await this.checkImplicitFavicon())return this.log("Found implicit favicon.ico"),{element:null,href:"/favicon.ico",type:"implicit"}}return this.log("No existing favicon detected"),null}catch(t){return this.logError("Error detecting existing favicon:",t),null}}async checkImplicitFavicon(){try{return(await fetch("/favicon.ico?"+Math.random(),{method:"HEAD",cache:"no-cache"})).ok}catch(t){return!1}}generatePageSignature(){try{const t=document.title||"",e=(window.location.href,window.location.hostname),i=window.getComputedStyle(document.body),o=i.backgroundColor||"",r=i.color||"",n=document.querySelectorAll('img[src*="logo" i], .logo, #logo'),a=n.length,c=Array.from(n).filter((t=>"IMG"===t.tagName)).map((t=>t.src)).slice(0,3),s={title:t.substring(0,100),domain:e,bodyBgColor:o,bodyTextColor:r,logoCount:a,logoSrcs:c,configHash:this.hashConfig(),version:"1.0.0"},l=JSON.stringify(s);return this.simpleHash(l)}catch(t){return this.logError("Error generating page signature:",t),this.simpleHash(document.title+window.location.hostname+Date.now())}}hashConfig(){try{const t={size:this.config.size,fallbackColor:this.config.fallbackColor,textColor:this.config.textColor,fontFamily:this.config.fontFamily,enableShadow:this.config.enableShadow};return this.simpleHash(JSON.stringify(t))}catch(t){return"default"}}simpleHash(t){let e=0;if(0===t.length)return e.toString();for(let i=0;i<t.length;i++){e=(e<<5)-e+t.charCodeAt(i),e&=e}return Math.abs(e).toString(16)}getCachedFavicon(){try{if("undefined"==typeof localStorage)return this.log("localStorage not available, skipping cache"),null;const t=localStorage.getItem(this.cacheKey);if(!t)return this.log("No cached favicon found"),null;const e=JSON.parse(t);if(!e.signature||!e.dataUrl||!e.timestamp)return this.log("Invalid cache structure, clearing cache"),this.clearCache(),null;const i=Date.now()-e.timestamp;return i>24*this.config.cacheExpiration*60*60*1e3?(this.log("Cache expired, clearing"),this.clearCache(),null):e.signature!==this.pageSignature?(this.log("Page signature changed, cache invalid"),this.clearCache(),null):(this.log("Valid cached favicon found"),e.dataUrl)}catch(t){return this.logError("Error reading cache:",t),this.clearCache(),null}}cacheFavicon(t){try{if("undefined"==typeof localStorage)return void this.log("localStorage not available, skipping cache storage");const e={signature:this.pageSignature,dataUrl:t,timestamp:Date.now(),version:"1.0.0"};localStorage.setItem(this.cacheKey,JSON.stringify(e)),this.log("Favicon cached successfully")}catch(t){this.logError("Error caching favicon:",t),"QuotaExceededError"===t.name&&(this.log("localStorage quota exceeded, clearing old cache"),this.clearCache())}}clearCache(){try{"undefined"!=typeof localStorage&&(localStorage.removeItem(this.cacheKey),this.log("Cache cleared"))}catch(t){this.logError("Error clearing cache:",t)}}getCacheInfo(){try{if("undefined"==typeof localStorage)return{available:!1};const t=localStorage.getItem(this.cacheKey);if(!t)return{available:!0,cached:!1};const e=JSON.parse(t),i=Date.now()-e.timestamp,o=24*this.config.cacheExpiration*60*60*1e3;return{available:!0,cached:!0,signature:e.signature,currentSignature:this.pageSignature,timestamp:e.timestamp,ageMinutes:Math.floor(i/6e4),maxAgeMinutes:Math.floor(o/6e4),expired:i>o,signatureMatch:e.signature===this.pageSignature}}catch(t){return{available:!0,cached:!1,error:t.message}}}async generate(){try{this.log("Starting favicon generation...");const t=this.extractPageInfo();this.log("Page info extracted:",t);const e=await this.analyzeDominantColor();this.log("Dominant color found:",e);const i=this.createFavicon(t.initials,e);return this.log("Favicon created successfully"),this.applyFavicon(i),this.log("Favicon applied to page"),this.initialized=!0,i}catch(t){return this.logError("Generation error:",t),this.retryCount<this.config.retryAttempts?(this.retryCount++,this.log(`Retrying generation (attempt ${this.retryCount}/${this.config.retryAttempts})...`),await new Promise((t=>setTimeout(t,500))),this.generate()):(this.log("Creating fallback favicon..."),this.createFallbackFavicon())}}extractPageInfo(){try{let t=document.title?.trim()||document.querySelector("h1")?.textContent?.trim()||document.querySelector('meta[property="og:title"]')?.getAttribute("content")?.trim()||document.querySelector('meta[name="title"]')?.getAttribute("content")?.trim()||"Website";const e=["the","and","or","but","in","on","at","to","for","of","with","by","a","an","&"],i=t.replace(/[^\w\s-]/g," ").split(/[\s\-_\.]+/).filter((t=>t.length>0)).filter((t=>!e.includes(t.toLowerCase())));let o="";for(let t=0;t<Math.min(2,i.length);t++){const e=i[t].charAt(0).toUpperCase();/[A-Z0-9]/.test(e)&&(o+=e)}if(o.length<2){const e=t.match(/[A-Z0-9]/g);e&&(o=e.slice(0,2).join(""))}return 0===o.length&&(o=t.substring(0,2).toUpperCase().replace(/[^A-Z0-9]/g,"W")),o=o||"W",{title:t,initials:o,words:i}}catch(t){return this.logError("Error extracting page info:",t),{title:"Website",initials:"W",words:["Website"]}}}async analyzeDominantColor(){try{const t=await this.extractLogoColor();if(t&&!this.isInvalidColor(t))return t;const e=this.extractStyleColor();if(e&&!this.isInvalidColor(e))return e;const i=this.extractCustomProperties();return i&&!this.isInvalidColor(i)?i:this.config.fallbackColor}catch(t){return this.logError("Error analyzing dominant color:",t),this.config.fallbackColor}}async extractLogoColor(){try{const t=['img[src*="logo" i]','img[alt*="logo" i]','img[class*="logo" i]','img[id*="logo" i]',".logo img, #logo img","header img:first-of-type",".header img:first-of-type","nav img:first-of-type",".brand img, .branding img"],e=new Set;if(t.forEach((t=>{try{document.querySelectorAll(t).forEach((t=>e.add(t)))}catch(t){}})),0===e.size)return this.log("No logo images found"),null;this.log(`Found ${e.size} potential logo images`);for(const t of e)try{const e=await this.extractImageColor(t);if(e)return this.log(`Color extracted from logo: ${e}`),e}catch(e){this.log(`Failed to extract color from image: ${t.src}`);continue}return null}catch(t){return this.logError("Error extracting logo color:",t),null}}extractImageColor(t){return new Promise((e=>{try{const i=setTimeout((()=>e(null)),this.config.timeout),o=new Image;o.crossOrigin="anonymous",o.onload=()=>{try{clearTimeout(i);const t=document.createElement("canvas"),r=t.getContext("2d"),n=50;t.width=t.height=n,r.drawImage(o,0,0,n,n);const a=r.getImageData(0,0,n,n).data,c={},s=20;for(let t=0;t<a.length;t+=4){const e=a[t],i=a[t+1],o=a[t+2];if(a[t+3]<128)continue;if(e>240&&i>240&&o>240)continue;if(e<15&&i<15&&o<15)continue;const r=Math.floor(e/s)*s,n=Math.floor(i/s)*s,l=`${r},${n},${Math.floor(o/s)*s}`;c[l]=(c[l]||0)+1}let l=null,h=0;for(const[t,e]of Object.entries(c))if(e>h){h=e;const[i,o,r]=t.split(",").map(Number);l=this.rgbToHex(i,o,r)}e(l)}catch(t){clearTimeout(i),this.log("Error processing image data"),e(null)}},o.onerror=()=>{clearTimeout(i),e(null)},o.src=t.src}catch(t){e(null)}}))}extractStyleColor(){try{const t=[document.body,document.querySelector("header"),document.querySelector(".header"),document.querySelector("nav"),document.querySelector(".navbar"),document.querySelector(".nav"),document.querySelector("main"),document.querySelector(".main"),document.querySelector(".container")].filter(Boolean),e={};t.forEach((t=>{const i=window.getComputedStyle(t),o=i.backgroundColor;if(o&&"rgba(0, 0, 0, 0)"!==o&&"transparent"!==o){const t=this.colorToHex(o);t&&!this.isInvalidColor(t)&&(e[t]=(e[t]||0)+2)}const r=i.borderColor;if(r&&"rgba(0, 0, 0, 0)"!==r&&"transparent"!==r){const t=this.colorToHex(r);t&&!this.isInvalidColor(t)&&(e[t]=(e[t]||0)+1)}const n=i.color;if(n&&"rgba(0, 0, 0, 0)"!==n&&"transparent"!==n){const t=this.colorToHex(n);!t||this.isInvalidColor(t)||this.isNearBlack(t)||(e[t]=(e[t]||0)+.5)}}));let i=null,o=0;for(const[t,r]of Object.entries(e))r>o&&(o=r,i=t);return i}catch(t){return this.logError("Error extracting style color:",t),null}}extractCustomProperties(){try{const t=window.getComputedStyle(document.documentElement),e=["--primary-color","--brand-color","--accent-color","--theme-color","--main-color","--primary","--brand","--accent"];for(const i of e){const e=t.getPropertyValue(i).trim();if(e){const t=this.colorToHex(e);if(t&&!this.isInvalidColor(t))return this.log(`Found custom property ${i}: ${t}`),t}}return null}catch(t){return this.logError("Error extracting custom properties:",t),null}}createFavicon(t,e){try{this.canvas=document.createElement("canvas"),this.canvas.width=this.config.size,this.canvas.height=this.config.size,this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.config.size,this.config.size);const i=Math.floor(this.config.size*(1===t.length?.65:.5));this.ctx.font=`bold ${i}px ${this.config.fontFamily}`,this.ctx.fillStyle=this.config.textColor,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.config.enableShadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.3)",this.ctx.shadowOffsetX=1,this.ctx.shadowOffsetY=1,this.ctx.shadowBlur=1);const o=this.config.size/2,r=this.config.size/2;return this.ctx.fillText(t,o,r),this.canvas.toDataURL("image/png")}catch(t){throw this.logError("Error creating favicon:",t),t}}applyFavicon(t){try{document.querySelectorAll('link[rel*="icon"]').forEach((t=>{t.hasAttribute("data-manual")||t.remove()}));const e=document.createElement("link");e.rel="icon",e.type="image/png",e.href=t,e.setAttribute("data-auto-generated","true"),document.head.appendChild(e);const i=document.createElement("link");i.rel="shortcut icon",i.type="image/png",i.href=t,i.setAttribute("data-auto-generated","true"),document.head.appendChild(i),this.log("Favicon applied successfully")}catch(t){throw this.logError("Error applying favicon:",t),t}}createFallbackFavicon(){try{this.log("Creating fallback favicon...");const t=this.createFavicon("W",this.config.fallbackColor);return this.applyFavicon(t),t}catch(t){return this.logError("Error creating fallback favicon:",t),null}}colorToHex(t){try{if(!t)return null;if(t.startsWith("#"))return 7===t.length?t:null;const e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(e){const t=parseInt(e[1]),i=parseInt(e[2]),o=parseInt(e[3]);return this.rgbToHex(t,i,o)}const i=t.match(/hsla?\((\d+),\s*(\d+)%,\s*(\d+)%/);if(i){const t=parseInt(i[1]),e=parseInt(i[2])/100,o=parseInt(i[3])/100;return this.hslToHex(t,e,o)}return null}catch(t){return null}}rgbToHex(t,e,i){return`#${((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1)}`}hslToHex(t,e,i){const o=(t,e,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t),r=i<.5?i*(1+e):i+e-i*e,n=2*i-r,a=Math.round(255*o(n,r,t/360+1/3)),c=Math.round(255*o(n,r,t/360)),s=Math.round(255*o(n,r,t/360-1/3));return this.rgbToHex(a,c,s)}isInvalidColor(t){return this.isNearWhite(t)||this.isNearBlack(t)||!t||7!==t.length}isNearWhite(t){if(!t||7!==t.length)return!1;const e=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return e>240&&i>240&&o>240}isNearBlack(t){if(!t||7!==t.length)return!1;const e=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return e<30&&i<30&&o<30}log(...t){this.config.enableLogging&&console.log("[FaviconGenerator]",...t)}logError(...t){console.error("[FaviconGenerator]",...t)}async regenerate(t={}){try{return this.config={...this.config,...t},this.retryCount=0,this.config.forceRegenerate&&this.clearCache(),this.pageSignature=this.generatePageSignature(),await this.generate()}catch(t){return this.logError("Error during regeneration:",t),this.createFallbackFavicon()}}getConfig(){return{...this.config}}updateConfig(t){this.config={...this.config,...t},this.log("Configuration updated:",this.config)}async forceClearAndRegenerate(){return this.clearCache(),this.config.forceRegenerate=!0,await this.regenerate()}}function createFaviconGenerator(t={}){return new FaviconGenerator(t)}function autoFavicon(e={}){return t.faviconGenerator||(t.faviconGenerator=createFaviconGenerator(e)),t.faviconGenerator.init()}"undefined"!=typeof module&&module.exports?module.exports={FaviconGenerator:FaviconGenerator,createFaviconGenerator:createFaviconGenerator,autoFavicon:autoFavicon}:"function"==typeof define&&define.amd?define([],(function(){return{FaviconGenerator:FaviconGenerator,createFaviconGenerator:createFaviconGenerator,autoFavicon:autoFavicon}})):(t.FaviconGenerator=FaviconGenerator,t.createFaviconGenerator=createFaviconGenerator,t.autoFavicon=autoFavicon,"undefined"==typeof window||t.DISABLE_AUTO_FAVICON||setTimeout((()=>{autoFavicon()}),100))}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);